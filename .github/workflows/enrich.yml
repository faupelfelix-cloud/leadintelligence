name: Enrich Leads

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'What to run'
        required: true
        type: choice
        options:
          - 'Test (5 companies)'
          - 'Enrich Companies'
          - 'Enrich Leads'
          - 'Enrich Both (Companies + Leads)'
          - 'Re-enrich Low Confidence Companies'
          - 'Re-enrich Companies Below Threshold'
          - 'Batch Enrich Companies (parallel)'
          - 'Batch Enrich Leads (parallel)'
          - 'Validate Setup Only'
      limit:
        description: 'Limit number of records per batch (default: 200)'
        required: false
        type: string
        default: '200'
      batch_number:
        description: 'For batch mode: specific batch (0-9) or "all" for parallel'
        required: false
        type: string
        default: 'all'
      icp_threshold:
        description: 'For re-enrich threshold mode: ICP score cutoff (e.g. 50)'
        required: false
        type: string
        default: '50'

jobs:
  # Single job for non-batch tasks
  enrich-single:
    if: github.event.inputs.task != 'Batch Enrich Companies (parallel)' && github.event.inputs.task != 'Batch Enrich Leads (parallel)'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Create config from secrets
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python setup.py
    
    - name: Run selected task
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        TASK="${{ github.event.inputs.task }}"
        LIMIT="${{ github.event.inputs.limit }}"
        
        if [ "$TASK" = "Test (5 companies)" ]; then
          echo "Running test with 5 companies..."
          python enrich_companies.py --limit 5
          
        elif [ "$TASK" = "Enrich Companies" ]; then
          if [ -n "$LIMIT" ] && [ "$LIMIT" != "200" ]; then
            echo "Enriching companies (limit: $LIMIT)..."
            python enrich_companies.py --limit $LIMIT
          else
            echo "Enriching all companies..."
            python enrich_companies.py
          fi
          
        elif [ "$TASK" = "Enrich Leads" ]; then
          if [ -n "$LIMIT" ] && [ "$LIMIT" != "200" ]; then
            echo "Enriching leads (limit: $LIMIT)..."
            python enrich_leads.py --limit $LIMIT
          else
            echo "Enriching all leads..."
            python enrich_leads.py
          fi
          
        elif [ "$TASK" = "Enrich Both (Companies + Leads)" ]; then
          if [ -n "$LIMIT" ] && [ "$LIMIT" != "200" ]; then
            echo "Enriching companies and leads (limit: $LIMIT each)..."
            python enrich_companies.py --limit $LIMIT
            python enrich_leads.py --limit $LIMIT
          else
            echo "Enriching all companies and leads..."
            python enrich_companies.py
            python enrich_leads.py
          fi
          
        elif [ "$TASK" = "Validate Setup Only" ]; then
          echo "Validating setup..."
          python validate_setup.py
          
        elif [ "$TASK" = "Re-enrich Low Confidence Companies" ]; then
          if [ -n "$LIMIT" ] && [ "$LIMIT" != "200" ]; then
            echo "Re-enriching low confidence companies (limit: $LIMIT)..."
            python enrich_companies.py --re-enrich-low-confidence --limit $LIMIT
          else
            echo "Re-enriching all low confidence companies..."
            python enrich_companies.py --re-enrich-low-confidence
          fi
          
        elif [ "$TASK" = "Re-enrich Companies Below Threshold" ]; then
          THRESHOLD="${{ github.event.inputs.icp_threshold || '50' }}"
          if [ -n "$LIMIT" ] && [ "$LIMIT" != "200" ]; then
            echo "Re-enriching companies with ICP <= $THRESHOLD (limit: $LIMIT)..."
            python enrich_companies.py --re-enrich-threshold $THRESHOLD --limit $LIMIT
          else
            echo "Re-enriching all companies with ICP <= $THRESHOLD..."
            python enrich_companies.py --re-enrich-threshold $THRESHOLD
          fi
        fi
    
    - name: Upload enrichment log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: enrichment-log-${{ github.run_id }}
        path: enrichment.log
        retention-days: 30

  # Parallel batch processing for companies (2000+)
  enrich-batch-companies:
    if: github.event.inputs.task == 'Batch Enrich Companies (parallel)'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    strategy:
      fail-fast: false
      matrix:
        batch: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
    
    steps:
    - name: Check if this batch should run
      id: check
      run: |
        REQUESTED_BATCH="${{ github.event.inputs.batch_number }}"
        CURRENT_BATCH="${{ matrix.batch }}"
        
        if [ "$REQUESTED_BATCH" == "all" ] || [ -z "$REQUESTED_BATCH" ] || [ "$REQUESTED_BATCH" == "$CURRENT_BATCH" ]; then
          echo "run=true" >> $GITHUB_OUTPUT
          echo "Running batch $CURRENT_BATCH"
        else
          echo "run=false" >> $GITHUB_OUTPUT
          echo "Skipping batch $CURRENT_BATCH (requested: $REQUESTED_BATCH)"
        fi
    
    - name: Checkout code
      if: steps.check.outputs.run == 'true'
      uses: actions/checkout@v4
    
    - name: Set up Python
      if: steps.check.outputs.run == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      if: steps.check.outputs.run == 'true'
      run: |
        pip install -r requirements.txt
    
    - name: Create config from secrets
      if: steps.check.outputs.run == 'true'
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python setup.py
    
    - name: Run batch enrichment
      if: steps.check.outputs.run == 'true'
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        BATCH="${{ matrix.batch }}"
        LIMIT="${{ github.event.inputs.limit || '200' }}"
        OFFSET=$((BATCH * LIMIT))
        
        echo "============================================================"
        echo "BATCH $BATCH: Processing companies $OFFSET to $((OFFSET + LIMIT - 1))"
        echo "============================================================"
        
        python enrich_companies.py --limit $LIMIT --offset $OFFSET
    
    - name: Upload logs
      if: always() && steps.check.outputs.run == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: enrichment-companies-batch-${{ matrix.batch }}-${{ github.run_id }}
        path: |
          *.log
        retention-days: 30

  # Parallel batch processing for leads (2000+)
  enrich-batch-leads:
    if: github.event.inputs.task == 'Batch Enrich Leads (parallel)'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    strategy:
      fail-fast: false
      matrix:
        batch: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
    
    steps:
    - name: Check if this batch should run
      id: check
      run: |
        REQUESTED_BATCH="${{ github.event.inputs.batch_number }}"
        CURRENT_BATCH="${{ matrix.batch }}"
        
        if [ "$REQUESTED_BATCH" == "all" ] || [ -z "$REQUESTED_BATCH" ] || [ "$REQUESTED_BATCH" == "$CURRENT_BATCH" ]; then
          echo "run=true" >> $GITHUB_OUTPUT
          echo "Running batch $CURRENT_BATCH"
        else
          echo "run=false" >> $GITHUB_OUTPUT
          echo "Skipping batch $CURRENT_BATCH (requested: $REQUESTED_BATCH)"
        fi
    
    - name: Checkout code
      if: steps.check.outputs.run == 'true'
      uses: actions/checkout@v4
    
    - name: Set up Python
      if: steps.check.outputs.run == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      if: steps.check.outputs.run == 'true'
      run: |
        pip install -r requirements.txt
    
    - name: Create config from secrets
      if: steps.check.outputs.run == 'true'
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python setup.py
    
    - name: Run batch enrichment
      if: steps.check.outputs.run == 'true'
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        BATCH="${{ matrix.batch }}"
        LIMIT="${{ github.event.inputs.limit || '200' }}"
        OFFSET=$((BATCH * LIMIT))
        
        echo "============================================================"
        echo "BATCH $BATCH: Processing leads $OFFSET to $((OFFSET + LIMIT - 1))"
        echo "============================================================"
        
        python enrich_leads.py --limit $LIMIT --offset $OFFSET
    
    - name: Upload logs
      if: always() && steps.check.outputs.run == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: enrichment-leads-batch-${{ matrix.batch }}-${{ github.run_id }}
        path: |
          *.log
        retention-days: 30
