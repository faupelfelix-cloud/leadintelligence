name: Conference Intelligence Monitoring

on:
  # Run every 2 weeks (1st and 15th of each month)
  schedule:
    - cron: '0 8 1,15 * *'  # 8 AM UTC on 1st and 15th
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if disabled in config'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# Set this to false to disable scheduled runs
env:
  CONFERENCE_INTELLIGENCE_ENABLED: 'false'  # Change to 'true' to enable

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check if enabled
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_run }}" == "true" ]; then
          echo "Force run requested - continuing..."
        elif [ "$CONFERENCE_INTELLIGENCE_ENABLED" != "true" ]; then
          echo "============================================================"
          echo "CONFERENCE INTELLIGENCE IS DISABLED"
          echo "============================================================"
          echo "To enable:"
          echo "1. Edit .github/workflows/conference_monitoring.yml"
          echo "2. Change CONFERENCE_INTELLIGENCE_ENABLED to 'true'"
          echo "3. Or use 'Run workflow' button with force_run=true"
          echo "============================================================"
          exit 0
        fi
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Create config from secrets
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python setup.py
    
    - name: Diagnose conferences (show why conferences are/aren't monitored)
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "Running diagnostics to show monitoring criteria..."
        python diagnose_conferences.py || echo "Diagnostics failed but continuing..."
    
    - name: Run conference intelligence monitoring
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "Starting Conference Intelligence monitoring..."
        python conference_intelligence.py
    
    - name: Upload log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: conference-intelligence-log
        path: conference_intelligence.log
        retention-days: 90
