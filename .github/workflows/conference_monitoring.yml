name: Conference Intelligence Monitoring

on:
  # Run bi-weekly (1st and 15th of each month)
  schedule:
    - cron: '0 8 1,15 * *'  # 8 AM UTC on 1st and 15th
  
  # Manual trigger
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Create config from secrets
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python setup.py
    
    - name: Diagnose conferences (show why conferences are/aren't monitored)
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "Running diagnostics to show monitoring criteria..."
        python diagnose_conferences.py || echo "Diagnostics failed but continuing..."
    
    - name: Run conference intelligence monitoring
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "============================================================"
        echo "CONFERENCE INTELLIGENCE - BI-WEEKLY MONITORING"
        echo "Forward-looking: Finds upcoming conferences and speaker lists"
        echo "============================================================"
        python conference_intelligence.py
    
    - name: Upload log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: conference-intelligence-log-${{ github.run_id }}
        path: conference_intelligence.log
        retention-days: 90
