name: Enrich Leads

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'What to run'
        required: true
        type: choice
        options:
          - 'Test (5 companies)'
          - 'Enrich Companies'
          - 'Enrich Leads'
          - 'Enrich Both (Companies + Leads)'
          - 'Validate Setup Only'
      limit:
        description: 'Limit number of records (leave empty for all)'
        required: false
        type: string

jobs:
  enrich:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Create config from secrets
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python setup.py
    
    - name: Run selected task
      env:
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        TASK="${{ github.event.inputs.task }}"
        LIMIT="${{ github.event.inputs.limit }}"
        
        if [ "$TASK" = "Test (5 companies)" ]; then
          echo "Running test with 5 companies..."
          python enrich_companies.py --limit 5
          
        elif [ "$TASK" = "Enrich Companies" ]; then
          if [ -n "$LIMIT" ]; then
            echo "Enriching companies (limit: $LIMIT)..."
            python enrich_companies.py --limit $LIMIT
          else
            echo "Enriching all companies..."
            python enrich_companies.py
          fi
          
        elif [ "$TASK" = "Enrich Leads" ]; then
          if [ -n "$LIMIT" ]; then
            echo "Enriching leads (limit: $LIMIT)..."
            python enrich_leads.py --limit $LIMIT
          else
            echo "Enriching all leads..."
            python enrich_leads.py
          fi
          
        elif [ "$TASK" = "Enrich Both (Companies + Leads)" ]; then
          if [ -n "$LIMIT" ]; then
            echo "Enriching companies and leads (limit: $LIMIT each)..."
            python enrich_companies.py --limit $LIMIT
            python enrich_leads.py --limit $LIMIT
          else
            echo "Enriching all companies and leads..."
            python enrich_companies.py
            python enrich_leads.py
          fi
          
        elif [ "$TASK" = "Validate Setup Only" ]; then
          echo "Validating setup..."
          python validate_setup.py
        fi
    
    - name: Upload enrichment log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: enrichment-log
        path: enrichment.log
        retention-days: 30
