name: Campaign Leads - Process

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'What to run'
        required: true
        type: choice
        options:
          - 'Standard Process'
          - 'Bulk Process (parallel)'
          - 'Enrich Only (skip outreach)'
          - 'Outreach Only (already enriched)'
          - 'Test (10 leads)'
      batch_size:
        description: 'Leads per batch (bulk mode)'
        required: false
        default: '200'
        type: choice
        options:
          - '100'
          - '200'
          - '300'
      campaign_type:
        description: 'Campaign type for outreach'
        required: false
        default: 'general'
        type: choice
        options:
          - 'general'
          - 'Conference'
          - 'Roadshow'
          - 'Webinar'
      limit:
        description: 'Max leads (standard mode only)'
        required: false
        type: number

jobs:
  # Single job for non-bulk tasks
  process-single:
    if: github.event.inputs.task != 'Bulk Process (parallel)' && github.event.inputs.task != 'Enrich Only (skip outreach)'
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyairtable anthropic pyyaml

      - name: Create config from secrets
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python setup.py

      - name: Process campaign leads
        run: |
          TASK="${{ github.event.inputs.task }}"
          CAMPAIGN_TYPE="${{ github.event.inputs.campaign_type || 'general' }}"
          LIMIT="${{ github.event.inputs.limit }}"

          echo "======================================================"
          echo "CAMPAIGN LEADS PROCESSOR"
          echo "Task: $TASK"
          echo "======================================================"

          case "$TASK" in
            "Test (10 leads)")
              python process_campaign_leads.py --limit 10 --campaign-type "$CAMPAIGN_TYPE"
              ;;
            "Standard Process")
              if [ -n "$LIMIT" ]; then
                python process_campaign_leads.py --limit $LIMIT --campaign-type "$CAMPAIGN_TYPE"
              else
                python process_campaign_leads.py --campaign-type "$CAMPAIGN_TYPE"
              fi
              ;;
            "Outreach Only (already enriched)")
              python process_campaign_leads.py --outreach-only --campaign-type "$CAMPAIGN_TYPE"
              ;;
          esac

      - name: Upload log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: campaign-leads-log-${{ github.run_id }}
          path: campaign_leads.log
          retention-days: 30

  # Parallel batch processing (10 parallel jobs)
  process-bulk:
    if: github.event.inputs.task == 'Bulk Process (parallel)' || github.event.inputs.task == 'Enrich Only (skip outreach)'
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        batch: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyairtable anthropic pyyaml

      - name: Create config from secrets
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python setup.py

      - name: Process batch
        run: |
          BATCH="${{ matrix.batch }}"
          BATCH_SIZE="${{ github.event.inputs.batch_size || '200' }}"
          CAMPAIGN_TYPE="${{ github.event.inputs.campaign_type || 'general' }}"
          TASK="${{ github.event.inputs.task }}"
          OFFSET=$((BATCH * BATCH_SIZE))

          echo "======================================================"
          echo "BATCH $BATCH: Processing leads $OFFSET to $((OFFSET + BATCH_SIZE - 1))"
          echo "======================================================"

          if [ "$TASK" = "Enrich Only (skip outreach)" ]; then
            python process_campaign_leads.py --enrich-only --limit $BATCH_SIZE --offset $OFFSET
          else
            python process_campaign_leads.py --limit $BATCH_SIZE --offset $OFFSET --campaign-type "$CAMPAIGN_TYPE"
          fi

      - name: Upload log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: campaign-leads-batch-${{ matrix.batch }}-${{ github.run_id }}
          path: campaign_leads.log
          retention-days: 30
