name: Campaign Leads - Process

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'What to run'
        required: true
        type: choice
        options:
          - 'Standard Process'
          - 'Bulk Process (2000+ leads)'
          - 'Enrich Only (skip outreach)'
          - 'Outreach Only (already enriched)'
          - 'Test (10 leads)'
      batch_size:
        description: 'Batch size for bulk mode'
        required: false
        default: '50'
        type: choice
        options:
          - '25'
          - '50'
          - '100'
      campaign_type:
        description: 'Campaign type for outreach'
        required: false
        default: 'general'
        type: choice
        options:
          - 'general'
          - 'Conference'
          - 'Roadshow'
          - 'Webinar'
      limit:
        description: 'Max leads (standard mode only)'
        required: false
        type: number

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyairtable anthropic pyyaml

      - name: Create config from secrets
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python setup.py

      - name: Process campaign leads
        run: |
          TASK="${{ github.event.inputs.task }}"
          BATCH_SIZE="${{ github.event.inputs.batch_size || '50' }}"
          CAMPAIGN_TYPE="${{ github.event.inputs.campaign_type || 'general' }}"
          LIMIT="${{ github.event.inputs.limit }}"

          echo "======================================================"
          echo "CAMPAIGN LEADS PROCESSOR"
          echo "======================================================"
          echo "Task: $TASK"
          echo "Batch size: $BATCH_SIZE"
          echo "Campaign type: $CAMPAIGN_TYPE"
          echo "Limit: ${LIMIT:-none}"
          echo "======================================================"

          case "$TASK" in
            "Test (10 leads)")
              python process_campaign_leads.py --limit 10 --campaign-type "$CAMPAIGN_TYPE"
              ;;
            "Standard Process")
              if [ -n "$LIMIT" ]; then
                python process_campaign_leads.py --limit $LIMIT --campaign-type "$CAMPAIGN_TYPE"
              else
                python process_campaign_leads.py --campaign-type "$CAMPAIGN_TYPE"
              fi
              ;;
            "Bulk Process (2000+ leads)")
              python process_campaign_leads.py --bulk --batch-size $BATCH_SIZE --campaign-type "$CAMPAIGN_TYPE"
              ;;
            "Enrich Only (skip outreach)")
              python process_campaign_leads.py --bulk --batch-size $BATCH_SIZE --skip-outreach
              ;;
            "Outreach Only (already enriched)")
              python process_campaign_leads.py --outreach-only --campaign-type "$CAMPAIGN_TYPE"
              ;;
          esac

      - name: Upload log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: campaign-leads-log-${{ github.run_id }}
          path: campaign_leads.log
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## Campaign Leads Processing" >> $GITHUB_STEP_SUMMARY
          echo "**Task:** ${{ github.event.inputs.task }}" >> $GITHUB_STEP_SUMMARY
          echo "**Batch Size:** ${{ github.event.inputs.batch_size }}" >> $GITHUB_STEP_SUMMARY
          echo "**Campaign Type:** ${{ github.event.inputs.campaign_type }}" >> $GITHUB_STEP_SUMMARY
